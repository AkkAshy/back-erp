# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–π

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **sales/serializers.py**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –≤–æ –≤—Å–µ—Ö docstrings –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `@transaction.atomic` –≤ `SaleCreateUpdateSerializer.create()` –∏ `update()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `select_for_update()` –≤ `SaleItemSerializer.validate()` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç race conditions

### 2. **sales/models.py**
–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

**CashRegister:**
- `code` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É
- `is_active` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Å—Å

**SaleItem:**
- `['sale', 'product']` - –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –≤ –ø—Ä–æ–¥–∞–∂–µ
- `batch` - –ø–æ–∏—Å–∫ –ø–æ –ø–∞—Ä—Ç–∏–∏ –¥–ª—è FEFO
- `product` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º

### 3. **sales/views.py**
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã:
- `CashRegisterViewSet` - –¥–æ–±–∞–≤–ª–µ–Ω `prefetch_related('sessions')`
- `SaleViewSet.complete()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞
- `SaleViewSet.cancel()` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related('reservation')`
- `SaleViewSet.refund()` - –¥–æ–±–∞–≤–ª–µ–Ω `select_related('reservation', 'batch')`

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

```bash
# –ï—Å–ª–∏ venv –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
source venv/bin/activate

# –ò–ª–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π –ø—É—Ç—å
source /path/to/your/venv/bin/activate
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è sales app
python manage.py makemigrations sales --name add_database_indexes

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
python manage.py showmigrations sales
```

### –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
python manage.py migrate sales

# –ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É
python manage.py migrate
```

### –®–∞–≥ 4 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î

```bash
# –í–æ–π–¥–∏—Ç–µ –≤ PostgreSQL
psql -U your_username -d your_database_name

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
\di sales_*

# –ò–ª–∏ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ
SELECT
    tablename,
    indexname,
    indexdef
FROM
    pg_indexes
WHERE
    tablename LIKE 'sales_%'
ORDER BY
    tablename,
    indexname;
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ race conditions**
- `select_for_update()` –≤ `SaleItemSerializer` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –¥–≤–∞ –∫–∞—Å—Å–∏—Ä–∞ –Ω–µ —Å–º–æ–≥—É—Ç –ø—Ä–æ–¥–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Ç–∏–∏

### 2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å**
- `@transaction.atomic` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–¥–∞–∂—É —Å —á–∞—Å—Ç–∏—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### 3. **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤**
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `sale + product` —É—Å–∫–æ—Ä—è—Ç –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —á–µ–∫–∞—Ö
- –ò–Ω–¥–µ–∫—Å –Ω–∞ `batch` —É—Å–∫–æ—Ä–∏—Ç FEFO —Å–ø–∏—Å–∞–Ω–∏–µ
- –ò–Ω–¥–µ–∫—Å –Ω–∞ `code` –¥–ª—è –∫–∞—Å—Å —É—Å–∫–æ—Ä–∏—Ç –ø–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É
- `select_related` –∏ `prefetch_related` —É–º–µ–Ω—å—à–∞—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

### –ü—Ä–∏–º–µ—Ä—ã –≤—ã–∏–≥—Ä—ã—à–∞:

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
# 1 –∑–∞–ø—Ä–æ—Å –Ω–∞ sale + N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ item
sale = Sale.objects.get(pk=1)
for item in sale.items.all():  # N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    print(item.product.name)
    print(item.batch.batch_number)
```

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
# –í—Å–µ–≥–æ 1 –∑–∞–ø—Ä–æ—Å –±–ª–∞–≥–æ–¥–∞—Ä—è prefetch_related
sale = Sale.objects.prefetch_related('items__product', 'items__batch').get(pk=1)
for item in sale.items.all():  # –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    print(item.product.name)
    print(item.batch.batch_number)
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
–î–æ–±–∞–≤—å—Ç–µ Django Debug Toolbar –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤:

```bash
pip install django-debug-toolbar
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```python
# –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
from django.core.cache import cache

categories = cache.get('active_categories')
if not categories:
    categories = Category.objects.filter(is_active=True)
    cache.set('active_categories', categories, 60 * 15)  # 15 –º–∏–Ω—É—Ç
```

### 3. Database Connection Pooling
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ django-db-pool –∏–ª–∏ pgbouncer –¥–ª—è –ø—É–ª–∏–Ω–≥–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å PostgreSQL.

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
python manage.py migrate sales <previous_migration_name>

# –ò–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π –∏ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—É—é
python manage.py showmigrations sales
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
2. ‚úÖ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞ –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —Å –¥–≤—É—Ö –∫–∞—Å—Å
3. ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞—Å—Å–æ–≤–æ–π —Å–º–µ–Ω—ã
4. ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞

–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! üéâ
