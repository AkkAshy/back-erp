# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ —É—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞

**–î–∞—Ç–∞:** 2025-11-22
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Ç–æ–≤–∞—Ä–∞ **–Ω–µ —É–º–µ–Ω—å—à–∞–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ** –Ω–∞ —Å–∫–ª–∞–¥–µ. –ú–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–¥–∞–≤–∞—Ç—å —Ç–æ–≤–∞—Ä –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ –±—ã–ª–æ –≤—Å–µ–≥–æ 10 —à—Ç—É–∫.

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –±–∞–≥–∏:

1. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏** - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∂—É –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ
2. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞** - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è** - –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–≤–∞—Ä –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥–µ

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

**–§–∞–π–ª:** [sales/views.py](sales/views.py#L489-L512)

```python
# –ü–†–û–í–ï–†–ö–ê –ù–ê–õ–ò–ß–ò–Ø –¢–û–í–ê–†–ê
# –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ inventory
available_qty = Decimal('0')
if hasattr(product, 'inventory') and product.inventory:
    if product.inventory.track_inventory:
        available_qty = Decimal(str(product.inventory.quantity or 0))
    else:
        # –ï—Å–ª–∏ —É—á–µ—Ç –Ω–µ –≤–µ–¥–µ—Ç—Å—è - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —Ç–æ–≤–∞—Ä –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω
        available_qty = Decimal('999999')
else:
    # –ï—Å–ª–∏ –Ω–µ—Ç inventory - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç
    available_qty = Decimal('0')

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–∫—É—â—É—é –ø—Ä–æ–¥–∞–∂—É
existing_item = SaleItem.objects.filter(
    sale=sale,
    product=product,
    batch=batch
).first()

current_qty_in_sale = existing_item.quantity if existing_item else Decimal('0')
total_requested = current_qty_in_sale + quantity

if total_requested > available_qty:
    return Response({
        'status': 'error',
        'code': 'insufficient_stock',
        'message': f'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: {available_qty}, –∑–∞–ø—Ä–æ—à–µ–Ω–æ: {total_requested}',
        'data': {
            'available': str(available_qty),
            'requested': str(total_requested),
            'current_in_sale': str(current_qty_in_sale)
        }
    }, status=status.HTTP_400_BAD_REQUEST)
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ `product.available_quantity`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∫–æ–ª—å–∫–æ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–∫—É—â—É—é –ø—Ä–æ–¥–∞–∂—É
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Å—Ç—É–ø–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∏ add_item

**–§–∞–π–ª:** [sales/views.py](sales/views.py#L593-L614)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –º–µ—Ç–æ–¥ `add_item()`.

### 3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** [products/models.py](products/models.py#L1310-L1328)

```python
def complete(self):
    """
    –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–≤–∞—Ä –ø—Ä–æ–¥–∞–Ω).
    –í–ê–ñ–ù–û: –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –ø–∞—Ä—Ç–∏–∏!
    """
    if self.status == 'active':
        # –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
        if self.batch:
            # –°–ø–∏—Å—ã–≤–∞–µ–º –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä—Ç–∏–∏
            self.batch.quantity -= self.quantity
            if self.batch.quantity < 0:
                self.batch.quantity = 0
            self.batch.save(update_fields=['quantity', 'updated_at'])
        # –ï—Å–ª–∏ –ø–∞—Ä—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞, —Ç–æ–≤–∞—Ä —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ø–∏—Å–∞–Ω –∏–∑ –ø–∞—Ä—Ç–∏–π
        # –ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞—Ä—Ç–∏—è—Ö

        # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è
        self.status = 'completed'
        self.save()
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø–∞—Ä—Ç–∏–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–º–∏–Ω–∏–º—É–º 0)
- –û–±–Ω–æ–≤–ª—è–µ—Ç `updated_at` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** [sales/models.py](sales/models.py#L558-L578)

```python
def create_stock_reservation(self):
    """–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"""
    from products.models import StockReservation

    if not self.reservation:
        reservation = StockReservation.objects.create(
            product=self.product,
            batch=self.batch,
            quantity=self.quantity,
            order_reference=self.sale.receipt_number,
            status='active',
            created_by=None
        )
        self.reservation = reservation
        self.save()

        # –°—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã —Å–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞
        reservation.complete()
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ–¥–∞–∂–∏
- **–°–†–ê–ó–£ –ñ–ï** –≤—ã–∑—ã–≤–∞–µ—Ç `reservation.complete()` –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
- –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–º–µ–Ω—å—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü—Ä–æ–¥–∞–∂–∞ —Ç–æ–≤–∞—Ä–∞

```
1. –ö–∞—Å—Å–∏—Ä —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä
   ‚Üì
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è available_quantity —Ç–æ–≤–∞—Ä–∞
   ‚Üì
3. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ–¥–∞–∂—É (pending)
   –ï—Å–ª–∏ –ù–ï –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí –û—à–∏–±–∫–∞ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ"
   ‚Üì
4. –ö–∞—Å—Å–∏—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ–¥–∞–∂—É (complete)
   ‚Üì
5. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ (StockReservation)
   ‚Üì
6. –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (reservation.complete())
   ‚Üì
7. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –£–ú–ï–ù–¨–®–ê–ï–¢–°–Ø:
   - –í –ø–∞—Ä—Ç–∏–∏: batch.quantity -= quantity
   - –í –æ–±—â–µ–º –∑–∞–ø–∞—Å–µ: pricing.stock_quantity -= quantity
```

### –ü—Ä–∏–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è:

**–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –¢–æ–≤–∞—Ä: "–ú–æ–ª–æ–∫–æ 1–ª"
- –ù–∞ —Å–∫–ª–∞–¥–µ: 10 —à—Ç—É–∫
- –¶–µ–Ω–∞: 70 —Å–æ–º

**–î–µ–π—Å—Ç–≤–∏—è:**

```bash
# 1. –°–∫–∞–Ω–∏—Ä—É–µ–º 5 —à—Ç—É–∫
POST /api/sales/sales/scan_item/
{
  "session": 1,
  "product": 123,
  "quantity": 5
}
‚Üí ‚úÖ Success (–¥–æ—Å—Ç—É–ø–Ω–æ 10, –∑–∞–ø—Ä–æ—à–µ–Ω–æ 5)

# 2. –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ 7 —à—Ç—É–∫
POST /api/sales/sales/scan_item/
{
  "session": 1,
  "product": 123,
  "quantity": 7
}
‚Üí ‚ùå Error: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: 10, –∑–∞–ø—Ä–æ—à–µ–Ω–æ: 12"
  (—É–∂–µ 5 –≤ –ø—Ä–æ–¥–∞–∂–µ + 7 –Ω–æ–≤—ã—Ö = 12 > 10)

# 3. –°–∫–∞–Ω–∏—Ä—É–µ–º –µ—â–µ 3 —à—Ç—É–∫–∏ (–≤—Å–µ–≥–æ 8)
POST /api/sales/sales/scan_item/
{
  "session": 1,
  "product": 123,
  "quantity": 3
}
‚Üí ‚úÖ Success (–¥–æ—Å—Ç—É–ø–Ω–æ 10, –∑–∞–ø—Ä–æ—à–µ–Ω–æ 8)

# 4. –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–¥–∞–∂—É
POST /api/sales/sales/{id}/complete/
‚Üí ‚úÖ Success
  - –°–æ–∑–¥–∞–Ω–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 8 —à—Ç—É–∫
  - –¢–æ–≤–∞—Ä —Å–ø–∏—Å–∞–Ω: stock_quantity: 10 ‚Üí 2
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ù–∞ —Å–∫–ª–∞–¥–µ –æ—Å—Ç–∞–ª–æ—Å—å: **2 —à—Ç—É–∫–∏**
- ‚úÖ –ü—Ä–æ–¥–∞–Ω–æ: **8 —à—Ç—É–∫**
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–¥–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å

```bash
# –¢–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ: 10 —à—Ç—É–∫

# –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å 15 —à—Ç—É–∫
curl -X POST http://localhost:8000/api/sales/sales/scan_item/ \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-Key: $TENANT_KEY" \
  -d '{
    "session": 1,
    "product": 123,
    "quantity": 15
  }'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "status": "error",
  "code": "insufficient_stock",
  "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: 10, –∑–∞–ø—Ä–æ—à–µ–Ω–æ: 15",
  "data": {
    "available": "10",
    "requested": "15",
    "current_in_sale": "0"
  }
}
```

### –¢–µ—Å—Ç 2: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏

```bash
# –ò—Å—Ö–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: 100 —à—Ç—É–∫

# 1. –°–∫–∞–Ω–∏—Ä—É–µ–º 30 —à—Ç—É–∫
POST /api/sales/sales/scan_item/
{"session": 1, "product": 123, "quantity": 30}
‚Üí Success

# 2. –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–¥–∞–∂—É
POST /api/sales/sales/{id}/complete/
‚Üí Success

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
GET /api/products/products/123/

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "id": 123,
  "available_quantity": "70.000",  # –ë—ã–ª–æ 100, –ø—Ä–æ–¥–∞–ª–∏ 30, –æ—Å—Ç–∞–ª–æ—Å—å 70
  "pricing": {
    "stock_quantity": "70.000"
  }
}
```

### –¢–µ—Å—Ç 3: –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∂—É

```bash
# –¢–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ: 10 —à—Ç—É–∫

# 1. –î–æ–±–∞–≤–ª—è–µ–º 6 —à—Ç—É–∫ –≤ –ø—Ä–æ–¥–∞–∂—É
POST /api/sales/sales/scan_item/
{"session": 1, "product": 123, "quantity": 6}
‚Üí Success

# 2. –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ 6 —à—Ç—É–∫ (–≤—Å–µ–≥–æ –±—É–¥–µ—Ç 12 > 10)
POST /api/sales/sales/scan_item/
{"session": 1, "product": 123, "quantity": 6}

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
{
  "status": "error",
  "code": "insufficient_stock",
  "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ. –î–æ—Å—Ç—É–ø–Ω–æ: 10, –∑–∞–ø—Ä–æ—à–µ–Ω–æ: 12",
  "data": {
    "available": "10",
    "requested": "12",
    "current_in_sale": "6"  # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ —É–∂–µ 6 –≤ –ø—Ä–æ–¥–∞–∂–µ
  }
}
```

---

## üìä –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **sales/views.py**
   - `SaleViewSet.scan_item()` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è + –∞–≤—Ç–æ–≤—ã–±–æ—Ä –ø–∞—Ä—Ç–∏–∏
   - `SaleViewSet.add_item()` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è

2. **products/models.py**
   - `StockReservation.complete()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞

3. **sales/models.py**
   - `SaleItem.create_stock_reservation()` - –¥–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–∑–æ–≤ `reservation.complete()` –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø–∞—Ä—Ç–∏–∏

**–§–∞–π–ª:** [sales/views.py](sales/views.py#L470-L477)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø–∞—Ä—Ç–∏–∏, `batch` –±—ã–ª `None`, –ø–æ—ç—Ç–æ–º—É –≤ `StockReservation.complete()` –ø—Ä–æ–≤–µ—Ä–∫–∞ `if self.batch:` –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ —É–º–µ–Ω—å—à–∞–ª–æ—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**

```python
else:
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø–∞—Ä—Ç–∏–∏ (FEFO - First Expired, First Out)
    # –í—ã–±–∏—Ä–∞–µ–º –ø–∞—Ä—Ç–∏—é —Å —Å–∞–º—ã–º —Ä–∞–Ω–Ω–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
    batch = ProductBatch.objects.filter(
        product=product,
        quantity__gte=quantity,
        is_active=True
    ).order_by('expiry_date', 'received_at').first()
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ï—Å–ª–∏ –ø–∞—Ä—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ - –≤—ã–±–∏—Ä–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FEFO –º–µ—Ç–æ–¥ (First Expired, First Out) - —Å–Ω–∞—á–∞–ª–∞ —Ç–æ–≤–∞—Ä —Å –±–ª–∏–∂–∞–π—à–∏–º —Å—Ä–æ–∫–æ–º –≥–æ–¥–Ω–æ—Å—Ç–∏
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –ø–∞—Ä—Ç–∏—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ available_quantity**
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç —É–∂–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä –≤ —Ç–µ–∫—É—â–µ–π –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –ø—Ä–æ–¥–∞–∂–µ
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É —Å –¥–µ—Ç–∞–ª—è–º–∏

2. **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—Ä–∏ complete()**
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ø–∞—Ä—Ç–∏—è–º–∏ (batch.quantity)
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—â–∏–º –∑–∞–ø–∞—Å–æ–º (pricing.stock_quantity)
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

3. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ**
‚úÖ **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏**
‚úÖ **–ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**
‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π**

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–î–∞—Ç–∞:** 2025-11-22
